# Code Execution, Preview, and Save Functionality

## Overview
I have successfully implemented comprehensive code execution, preview, and save functionality for the Marina LLM Chat GUI. These features allow users to interact with code blocks generated by LLMs in a dynamic and powerful way.

## Features Implemented

### 1. Code Block Detection and Extraction
- **Automatic Detection**: The system automatically detects code blocks in LLM responses using markdown-style triple backticks (```)
- **Language Recognition**: Supports multiple programming languages including Python, Shell/Bash, HTML, CSS, and JavaScript
- **Code Placeholder**: Replaces code blocks in the chat with "[Code Block N]" placeholders to keep the interface clean

### 2. Interactive Code Buttons
For each detected code block, three buttons are automatically generated:

#### üèÉ Run Button
- **Python Code**: Executes Python code safely in a temporary file with a 30-second timeout
- **Shell Commands**: Executes shell commands using the integrated action engine
- **HTML Code**: Opens HTML code in the default web browser
- **Smart Detection**: Automatically detects code type based on content and language indicators

#### üíæ Save Button
- **File Dialog**: Opens a native file dialog to choose save location
- **Multiple Formats**: Supports saving as .py, .sh, .html, .txt, and other formats
- **Error Handling**: Provides user feedback for successful saves or errors

#### üîç Preview Button
- **Full-Featured Editor**: Opens code in a dedicated preview window with:
  - Syntax highlighting-ready text widget
  - Line numbers
  - Scrollbars (horizontal and vertical)
  - Monospace font (Consolas) for better code readability
  - Theme support (dark/light)

### 3. Code Preview Window Features
- **Toolbar**: Run, Save, and Copy buttons for quick actions
- **Code Type Indicator**: Shows detected code type (PYTHON, SHELL, HTML, etc.)
- **Status Bar**: Displays line count and character count
- **Editable**: Users can modify code before executing
- **Modal Window**: Focused editing experience
- **Theme Integration**: Respects the current theme (dark/light)

### 4. Execution Engine Integration
- **Action Engine**: Integrates with the existing `brain/action_engine.py` for shell command execution
- **Threading**: All code execution runs in separate threads to prevent GUI freezing
- **Timeout Protection**: Python code execution has a 30-second timeout to prevent hanging
- **Error Handling**: Comprehensive error handling with user-friendly messages

### 5. Code Type Detection
The system intelligently detects code types based on:
- **Python**: `import`, `def`, `class`, `print(`, `if __name__`, etc.
- **HTML**: `<html`, `<head>`, `<body>`, `<div`, `<script>`, etc.
- **Shell**: `#!/bin/bash`, `cd`, `ls`, `mkdir`, `rm`, etc.
- **Language Tags**: Strips language identifiers from code blocks (e.g., `python`, `bash`, `html`)

### 6. Safety Features
- **Temporary Files**: Python and HTML code execution uses temporary files that are automatically cleaned up
- **Timeout Protection**: Python execution has a 30-second timeout
- **Error Isolation**: Each code execution is isolated and won't crash the main GUI
- **User Feedback**: Clear status messages for all operations

## Technical Implementation

### File Structure
```
gui/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ chat_feed.py          # Main implementation
‚îÇ   ‚îú‚îÄ‚îÄ llm_manager.py        # LLM integration
‚îÇ   ‚îî‚îÄ‚îÄ priming_manager.py    # Context management
‚îú‚îÄ‚îÄ themes/
‚îÇ   ‚îî‚îÄ‚îÄ themes.py             # Theme management
‚îî‚îÄ‚îÄ main_gui.py               # Main application
```

### Key Methods
- `run_code()`: Main entry point for code execution
- `detect_code_type()`: Intelligent code type detection
- `run_python_code()`: Safe Python execution with timeout
- `run_shell_code()`: Shell command execution via action engine
- `run_html_code()`: HTML rendering in browser
- `save_code()`: File saving with dialog
- `preview_code()`: Full-featured code preview window
- `extract_code_blocks_from_message()`: Code block parsing

### Dependencies
- **tkinter**: GUI framework
- **subprocess**: Code execution
- **tempfile**: Safe temporary file handling
- **threading**: Non-blocking execution
- **brain.action_engine**: Shell command execution

## Usage Examples

### Python Code Execution
```python
# LLM generates:
```python
print("Hello, World!")
for i in range(5):
    print(f"Count: {i}")
```

# Result: User sees Run/Save/Preview buttons
# Clicking Run executes the code and shows output in chat
```

### Shell Command Execution
```bash
# LLM generates:
```bash
ls -la
pwd
echo "Current directory contents:"
```

# Result: Commands execute via action engine
# Output appears in chat feed
```

### HTML Code Execution
```html
# LLM generates:
```html
<!DOCTYPE html>
<html>
<head><title>Test</title></head>
<body><h1>Hello from HTML!</h1></body>
</html>
```

# Result: HTML opens in default browser
```

## Error Handling
- **Python Errors**: Syntax errors, runtime errors, and timeouts are caught and displayed
- **Shell Errors**: Command failures are shown with stderr output
- **File Errors**: Save/load errors are handled gracefully
- **GUI Errors**: Threading prevents GUI freezing during execution

## Security Considerations
- **Sandboxing**: Code runs in the user's environment (not sandboxed)
- **Timeout**: Python execution has timeout protection
- **User Awareness**: Clear feedback about what code is being executed
- **File Cleanup**: Temporary files are automatically cleaned up

## Future Enhancements
- **Syntax Highlighting**: Could be enhanced with proper syntax highlighting
- **Code Completion**: Auto-completion in preview window
- **Multiple Language Support**: Additional language detection and execution
- **Sandboxing**: More secure execution environment
- **Code History**: Save and recall previously executed code blocks

This implementation provides a robust, user-friendly way to interact with code generated by LLMs, making the Marina GUI a powerful development environment.
