{% extends "base.html" %}

{% block title %}Analysis - Marina Web Client{% endblock %}

{% block extra_head %}
<style>
    .analysis-section {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
    }
    
    .analysis-section h5 {
        color: #495057;
        margin-bottom: 1rem;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
    }
    
    .metric-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .status-active { background-color: #28a745; }
    .status-inactive { background-color: #dc3545; }
    .status-warning { background-color: #ffc107; }
    
    .data-table {
        font-size: 0.875rem;
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .error-message {
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    
    .historical-chart {
        height: 300px;
        margin-top: 1rem;
    }
    
    .summary-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .summary-stat {
        flex: 1;
        min-width: 200px;
        background: white;
        padding: 1rem;
        border-radius: 0.375rem;
        border: 1px solid #e9ecef;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line me-2"></i>Sensory Analysis Dashboard</h2>
                <button id="refreshBtn" class="btn btn-primary">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error Message -->
    <div id="errorMessage" class="error-message">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span id="errorText"></span>
    </div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading analysis data...</span>
        </div>
        <p class="mt-2">Loading analysis data...</p>
    </div>
    
    <!-- Analysis Content -->
    <div id="analysisContent" style="display: none;">
        <div class="row">
            <!-- System Status Overview -->
            <div class="col-lg-4">
                <div class="analysis-section">
                    <h5><i class="fas fa-heartbeat me-2"></i>System Status</h5>
                    <div id="systemStatus">
                        <div class="metric-card">
                            <div class="metric-label">Overall Status</div>
                            <div id="overallStatus" class="metric-value">
                                <span class="status-indicator status-inactive"></span>Unknown
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active Sensors</div>
                            <div id="activeSensors" class="metric-value">0/9</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Last Update</div>
                            <div id="lastUpdate" class="metric-value">Never</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Audio Analysis -->
            <div class="col-lg-8">
                <div class="analysis-section">
                    <h5><i class="fas fa-microphone me-2"></i>Audio Analysis</h5>
                    <div id="audioAnalysis">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="metric-card">
                                    <div class="metric-label">Microphone Status</div>
                                    <div id="microphoneStatus" class="metric-value">
                                        <span class="status-indicator status-inactive"></span>Unknown
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card">
                                    <div class="metric-label">Current Level</div>
                                    <div id="audioLevel" class="metric-value">N/A</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Song Recognition -->
                        <div class="mt-3">
                            <h6><i class="fas fa-music me-2"></i>Song Recognition</h6>
                            <div id="songRecognition" class="data-table">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Song</th>
                                                <th>Artist</th>
                                                <th>Confidence</th>
                                                <th>Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="songRecognitionData">
                                            <tr>
                                                <td colspan="4" class="text-muted">No recent song recognition data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Soundscape Analysis -->
                        <div class="mt-3">
                            <h6><i class="fas fa-wave-square me-2"></i>Soundscape Detection</h6>
                            <div id="soundscapeAnalysis" class="summary-stats">
                                <div class="summary-stat">
                                    <div class="metric-label">Current Scene</div>
                                    <div id="currentSoundscape" class="metric-value">Unknown</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="metric-label">Confidence</div>
                                    <div id="soundscapeConfidence" class="metric-value">N/A</div>
                                </div>
                                <div class="summary-stat">
                                    <div class="metric-label">Duration</div>
                                    <div id="soundscapeDuration" class="metric-value">N/A</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Acoustic Trace Engine -->
            <div class="col-lg-6">
                <div class="analysis-section">
                    <h5><i class="fas fa-history me-2"></i>Acoustic Trace Engine</h5>
                    <div id="acousticTrace">
                        <div class="metric-card">
                            <div class="metric-label">Recent Events (24h)</div>
                            <div id="recentEvents" class="metric-value">0</div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>Recent Activity</h6>
                            <div id="acousticEvents" class="data-table">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Event Type</th>
                                                <th>Confidence</th>
                                                <th>Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody id="acousticEventsData">
                                            <tr>
                                                <td colspan="4" class="text-muted">No recent acoustic events</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visual Analysis -->
            <div class="col-lg-6">
                <div class="analysis-section">
                    <h5><i class="fas fa-eye me-2"></i>Visual Analysis</h5>
                    <div id="visualAnalysis">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="metric-card">
                                    <div class="metric-label">Camera Status</div>
                                    <div id="cameraStatus" class="metric-value">
                                        <span class="status-indicator status-inactive"></span>Unknown
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="metric-card">
                                    <div class="metric-label">Screen Capture</div>
                                    <div id="screenStatus" class="metric-value">
                                        <span class="status-indicator status-inactive"></span>Unknown
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Environmental Sensors -->
            <div class="col-12">
                <div class="analysis-section">
                    <h5><i class="fas fa-thermometer-half me-2"></i>Environmental Sensors</h5>
                    <div id="environmentalSensors">
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="metric-label">Thermal</div>
                                <div id="thermalStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                            <div class="summary-stat">
                                <div class="metric-label">Kinetic</div>
                                <div id="kineticStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                            <div class="summary-stat">
                                <div class="metric-label">Touch</div>
                                <div id="touchStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                            <div class="summary-stat">
                                <div class="metric-label">Taste</div>
                                <div id="tasteStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                            <div class="summary-stat">
                                <div class="metric-label">Smell</div>
                                <div id="smellStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                            <div class="summary-stat">
                                <div class="metric-label">Time Perception</div>
                                <div id="timeStatus" class="metric-value">
                                    <span class="status-indicator status-inactive"></span>Unknown
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Refresh Button -->
<button id="floatingRefreshBtn" class="btn btn-primary btn-lg refresh-btn rounded-circle" title="Refresh Analysis">
    <i class="fas fa-sync-alt"></i>
</button>
{% endblock %}

{% block extra_scripts %}
<script>
class AnalysisManager {
    constructor() {
        this.refreshInterval = null;
        this.autoRefreshEnabled = true;
        this.refreshRate = 30000; // 30 seconds
        
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.loadAnalysisData();
        this.startAutoRefresh();
    }
    
    bindEvents() {
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.loadAnalysisData();
        });
        
        document.getElementById('floatingRefreshBtn').addEventListener('click', () => {
            this.loadAnalysisData();
        });
    }
    
    startAutoRefresh() {
        if (this.autoRefreshEnabled) {
            this.refreshInterval = setInterval(() => {
                this.loadAnalysisData(true); // Silent refresh
            }, this.refreshRate);
        }
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    showLoading(silent = false) {
        if (!silent) {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('analysisContent').style.display = 'none';
        }
        document.getElementById('errorMessage').style.display = 'none';
    }
    
    hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('analysisContent').style.display = 'block';
    }
    
    showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('analysisContent').style.display = 'none';
    }
    
    async loadAnalysisData(silent = false) {
        this.showLoading(silent);
        
        try {
            // Load sensory status
            const sensoryResponse = await fetch('/api/sensory/status');
            if (!sensoryResponse.ok) {
                throw new Error(`HTTP error! status: ${sensoryResponse.status}`);
            }
            const sensoryData = await sensoryResponse.json();
            
            // Load analysis data
            const analysisResponse = await fetch('/api/analysis/data');
            let analysisData = {};
            if (analysisResponse.ok) {
                analysisData = await analysisResponse.json();
            }
            
            this.updateDisplay(sensoryData, analysisData);
            this.hideLoading();
            
        } catch (error) {
            console.error('Error loading analysis data:', error);
            this.showError(`Failed to load analysis data: ${error.message}`);
        }
    }
    
    updateDisplay(sensoryData, analysisData) {
        // Update system status
        this.updateSystemStatus(sensoryData);
        
        // Update audio analysis
        this.updateAudioAnalysis(sensoryData, analysisData);
        
        // Update visual analysis
        this.updateVisualAnalysis(sensoryData);
        
        // Update environmental sensors
        this.updateEnvironmentalSensors(sensoryData);
        
        // Update acoustic trace
        this.updateAcousticTrace(analysisData);
        
        // Update last update time
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
    
    updateSystemStatus(sensoryData) {
        if (!sensoryData.success) {
            this.setStatusIndicator('overallStatus', 'error', 'Error');
            document.getElementById('activeSensors').textContent = '0/9';
            return;
        }
        
        let activeSensors = 0;
        let totalSensors = 0;
        
        // Count active sensors
        const status = sensoryData.status;
        const sensors = ['audio', 'thermal', 'kinetic', 'touch', 'time', 'taste', 'smell'];
        
        sensors.forEach(sensor => {
            totalSensors++;
            if (status[sensor] && status[sensor].available && status[sensor].active) {
                activeSensors++;
            }
        });
        
        // Visual sensors (camera and screen)
        if (status.visual) {
            totalSensors += 2;
            if (status.visual.camera && status.visual.camera.available && status.visual.camera.active) {
                activeSensors++;
            }
            if (status.visual.screen && status.visual.screen.available && status.visual.screen.active) {
                activeSensors++;
            }
        }
        
        document.getElementById('activeSensors').textContent = `${activeSensors}/${totalSensors}`;
        
        // Overall status
        if (activeSensors === 0) {
            this.setStatusIndicator('overallStatus', 'inactive', 'All Offline');
        } else if (activeSensors === totalSensors) {
            this.setStatusIndicator('overallStatus', 'active', 'All Online');
        } else {
            this.setStatusIndicator('overallStatus', 'warning', 'Partial');
        }
    }
    
    updateAudioAnalysis(sensoryData, analysisData) {
        // Microphone status
        const audioStatus = sensoryData.status?.audio;
        if (audioStatus) {
            if (audioStatus.available && audioStatus.active) {
                this.setStatusIndicator('microphoneStatus', 'active', 'Active');
            } else if (audioStatus.available) {
                this.setStatusIndicator('microphoneStatus', 'warning', 'Available');
            } else {
                this.setStatusIndicator('microphoneStatus', 'inactive', 'Offline');
            }
        }
        
        // Song recognition data
        if (analysisData.song_recognition) {
            this.updateSongRecognition(analysisData.song_recognition);
        }
        
        // Soundscape data
        if (analysisData.soundscape) {
            this.updateSoundscape(analysisData.soundscape);
        }
    }
    
    updateSongRecognition(songData) {
        const tbody = document.getElementById('songRecognitionData');
        tbody.innerHTML = '';
        
        if (songData.recent_songs && songData.recent_songs.length > 0) {
            songData.recent_songs.forEach(song => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${song.title || 'Unknown'}</td>
                    <td>${song.artist || 'Unknown'}</td>
                    <td>${song.confidence ? (song.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                    <td>${song.timestamp ? new Date(song.timestamp).toLocaleTimeString() : 'N/A'}</td>
                `;
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No recent song recognition data</td></tr>';
        }
    }
    
    updateSoundscape(soundscapeData) {
        document.getElementById('currentSoundscape').textContent = soundscapeData.current_scene || 'Unknown';
        document.getElementById('soundscapeConfidence').textContent = soundscapeData.confidence ? 
            (soundscapeData.confidence * 100).toFixed(1) + '%' : 'N/A';
        document.getElementById('soundscapeDuration').textContent = soundscapeData.duration || 'N/A';
    }
    
    updateVisualAnalysis(sensoryData) {
        const visualStatus = sensoryData.status?.visual;
        if (visualStatus) {
            // Camera status
            if (visualStatus.camera) {
                if (visualStatus.camera.available && visualStatus.camera.active) {
                    this.setStatusIndicator('cameraStatus', 'active', 'Active');
                } else if (visualStatus.camera.available) {
                    this.setStatusIndicator('cameraStatus', 'warning', 'Available');
                } else {
                    this.setStatusIndicator('cameraStatus', 'inactive', 'Offline');
                }
            }
            
            // Screen status
            if (visualStatus.screen) {
                if (visualStatus.screen.available && visualStatus.screen.active) {
                    this.setStatusIndicator('screenStatus', 'active', 'Active');
                } else if (visualStatus.screen.available) {
                    this.setStatusIndicator('screenStatus', 'warning', 'Available');
                } else {
                    this.setStatusIndicator('screenStatus', 'inactive', 'Offline');
                }
            }
        }
    }
    
    updateEnvironmentalSensors(sensoryData) {
        const sensors = ['thermal', 'kinetic', 'touch', 'taste', 'smell', 'time'];
        const sensorIds = ['thermalStatus', 'kineticStatus', 'touchStatus', 'tasteStatus', 'smellStatus', 'timeStatus'];
        
        sensors.forEach((sensor, index) => {
            const sensorStatus = sensoryData.status?.[sensor];
            const elementId = sensorIds[index];
            
            if (sensorStatus) {
                if (sensorStatus.available && sensorStatus.active) {
                    this.setStatusIndicator(elementId, 'active', 'Active');
                } else if (sensorStatus.available) {
                    this.setStatusIndicator(elementId, 'warning', 'Available');
                } else {
                    this.setStatusIndicator(elementId, 'inactive', 'Offline');
                }
            }
        });
    }
    
    updateAcousticTrace(analysisData) {
        if (analysisData.acoustic_trace) {
            const traceData = analysisData.acoustic_trace;
            document.getElementById('recentEvents').textContent = traceData.recent_count || 0;
            
            // Update events table
            const tbody = document.getElementById('acousticEventsData');
            tbody.innerHTML = '';
            
            if (traceData.recent_events && traceData.recent_events.length > 0) {
                traceData.recent_events.forEach(event => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${event.timestamp ? new Date(event.timestamp).toLocaleTimeString() : 'N/A'}</td>
                        <td>${event.event_type || 'Unknown'}</td>
                        <td>${event.confidence ? (event.confidence * 100).toFixed(1) + '%' : 'N/A'}</td>
                        <td>${event.duration || 'N/A'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-muted">No recent acoustic events</td></tr>';
            }
        }
    }
    
    setStatusIndicator(elementId, status, text) {
        const element = document.getElementById(elementId);
        const indicator = element.querySelector('.status-indicator');
        
        // Remove all status classes
        indicator.classList.remove('status-active', 'status-inactive', 'status-warning');
        
        // Add appropriate class
        indicator.classList.add(`status-${status}`);
        
        // Update text (preserve indicator)
        const textNode = element.childNodes[element.childNodes.length - 1];
        if (textNode.nodeType === Node.TEXT_NODE) {
            textNode.textContent = text;
        } else {
            element.appendChild(document.createTextNode(text));
        }
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    window.analysisManager = new AnalysisManager();
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (window.analysisManager) {
        window.analysisManager.stopAutoRefresh();
    }
});
</script>
{% endblock %}
